@page "/login"
@inject IJSRuntime JS
<PageTitle>Login</PageTitle>

<div class="container">
    <h1>Login</h1>

    <div class="col-md-6">
        <p>Authentication powered by Okta Auth0</p>
    </div>

    <button class="btn btn-primary" @onclick="_Login" disabled="@processRegistration">Secure Login with Auth0</button>

    @if (!string.IsNullOrEmpty(CodeParameter))
    {
        <div class="alert alert-success mt-3" role="alert">
            Success! You're logged in. Redirecting to dashboard...
        </div>
    }

</div>



@code {
    private bool processRegistration = false;
    private bool codeExists = false;
    string CodeParameter;

    [Inject]
    NavigationManager NavigationManager { get; set; }

    private async void _Login(){
        processRegistration = true;
        var authorizeUrl = $"https://dev-pa3bipmqjbfbdc4d.us.auth0.com/authorize" +
    $"?response_type=code" +
    $"&client_id=bUPQBV3ZgatRowJgPIfpKQhnddlrjO8B" +
    $"&redirect_uri=https://ameyplayground.azurewebsites.net/login";
        NavigationManager.NavigateTo(authorizeUrl);
    }

    protected override void OnInitialized()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
        CodeParameter = queryParams["code"];

        if (!string.IsNullOrEmpty(CodeParameter))
        {
            processRegistration = true;
            // Still need to get the AuthToken from Auth0 for the user
            JS.InvokeVoidAsync("localStorage.setItem", "authToken", CodeParameter);
        }
    }


}
